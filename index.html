<html>
    <head>
        <script src="./bundle.js"></script>
        <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
        <link rel="stylesheet" type="text/css" href="semantic/dist/components/accordion.min.css">
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script src="semantic/dist/semantic.min.js"></script>
        <script src="semantic/dist/components/accordion.min.js"></script>
        <script>
            var hdkey = new new Coval.Coval().Secure.HDKey()
            var keys = []
            var share, emblem
            function getWallet() {
                if (!localStorage.getItem('coval-testnet')) {
                    keys[0] = hdkey.StandardHDKey('0', function(address, key){
                        localStorage.setItem('coval-testnet', JSON.stringify([{address: address, key: key }]))
                        return {address: address, key: key }
                    })
                } else {
                    keys = JSON.parse(localStorage.getItem('coval-testnet'))
                }
                $(".my-address").text(keys[0].address)
                getBalance()
            }
            
            function getShare() {
                $(".loading").show()
                $.ajax({
                    url: "http://35.224.43.101/split",
                    context: document.body
                }).done(function(val) {
                    share = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    getToken(val)
                })
            }
            function getToken(shares) {
                var shares = shares
                var tokenUrl = "http://35.224.43.101/address-import?address=" + keys[0].address + "&name=" + $('.requested-name').val()
                
                $.ajax({
                    url: tokenUrl,
                    context: document.body
                }).done(function(val) {
                    emblem = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    if (!keys[0].emblems) {keys[0].emblems = []}
                    keys[0].emblems[keys[0].emblems.length] = {name: val.name, shares: shares}
                    localStorage.setItem('coval-testnet', JSON.stringify(keys))
                    getBalance()
                })
            }

            function getBalance() {
                $(".loading").show()
                $(".emblems").html("")
                var tokenUrl = "http://35.224.43.101/address-balances?address=" + keys[0].address
                $.ajax({
                    url: tokenUrl,
                    context: document.body
                }).done(function(val) {
                    emblem = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    var emblemHtml = "<div class='emblem ui styled accordion'>"
                    val.forEach((element, index) => {
                        var validity = "(no shares stored)"
                        if (isClaimable(element.name)) {
                            validity = "(claimable)"
                        }
                        /*
                        
                        
                        */
                        emblemHtml = emblemHtml + "<div class='title'><i class='dropdown icon'></i>"+element.name+" "+validity+"</div><div class='content'><p class='transition hidden'>"//)//"<div class='ui header'>"+element.name+" "+validity+"</div>"
                        var addresses = getEmblemInternalAddresses(element.name)
                        Object.keys(addresses).forEach((key, i) => {
                            var address = addresses[key]
                            emblemHtml = emblemHtml + "<div>" + key + " : " + address + "</div>"
                            if (i == Object.keys(addresses).length -1) {
                                emblemHtml = emblemHtml + "</p></div>"
                                
                            }
                        })
                        if (index == val.length -1) {
                            //emblemHtml = emblemHtml + "</div>"
                            $(".emblems").append(emblemHtml)
                        }
                    })
                    $('.ui.sticky').sticky({
                        context: '#context'
                    })
                    $(".loading").hide()
                    $('.emblem.ui.accordion').accordion()
                })
            }

            function isClaimable(name) {
                return keys[0].emblems.filter(function(emblem){return emblem.name == name}).length > 0
            }

            function getEmblemInternalAddresses(name) {
                return keys[0].emblems.filter(function(emblem){return emblem.name == name})[0].shares.payload.addresses
            }

            $( document ).ready(function() {
                getWallet()                
            });
        </script>
        <style>
            .raw-data {
                width: 100%;
                /* height: -webkit-fill-available; */
                visibility:collapse;
            }
            .loading {
                display: none;
            }
            .ui.rail {
                padding-left: 15px;
            }
        </style>
    </head>
    <body>
        <div class="ui text container">
            <div class="ui rail">
                <div class="ui sticky">
                    <div>My Address: <div class="my-address"></div></div>
                    <hr>
                    <div>Emblem Name: <input class="requested-name"/></div>
                    <button onclick="getShare()">Create Emblem</button> <button onclick="getBalance()">My Emblems</button>
                    <hr>
                </div>
            </div>
        </div>
        <div class="ui" id="context">
                <div class="ui icon attached loading message">
                    <i class="notched circle loading icon"></i>
                    <div class="content">
                        <div class="header">
                        Just one second
                        </div>
                        <p>We're fetching that content for you.</p>
                    </div>
                </div>
            <textarea class="raw-data"></textarea>
            <div class="emblems">

            </div>
        </div>
    </body>
</html>