<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Emblem Alpha Client</title>

        
        <style>
            .raw-data {
                width: 100%;
                /* height: -webkit-fill-available; */
                visibility:collapse;
            }
            .loading {
                display: none;
            }
            .ui.rail {
                padding-left: 15px;
            }
            .send {
                padding: .38571429em 1em 1.4em !important;
            }
            .reset {
                float: right;
            }
            .unit {
                margin-right: 2px;
                margin-bottom: -2px;
            }
        </style>
</head>
<body>
    <div></div>
    <div class="ui raised very padded text container segment">
        
        <h2 class="ui header">Emblem AlphaNet</h2>
        <div class="my-address"></div>
        <hr>
        <div class="reset"><div onclick="reset()" class="ui red label submit button transition visible">Reset Wallet!</div></div>
        <p>Welcome to the Emblem Vault - alpha client. </p> 
        <p><b>IMPORTANT! </b>This is not secure and may go away at any time. You should not send any value to your vaults that you don't want to lose! </p>
        <div class="ui segment">
            <div class="ui fluid form">
                <div class="three fields">
                    <div class="field">
                        <label>Emblem Name</label>
                        <input class="requested-name" placeholder="My secret vault" type="text">
                    </div>
                    <div class="four wide field">
                        <label>Private</label>
                        <div class="ui toggle checkbox">                           
                            <input type="checkbox" name="private" tabindex="0" class="hidden">                          
                        </div>
                      </div>
                    <div class="eight wide field">
                            <label>Activity</label>
                        <div onclick="getShare()" class="ui secondary submit button">New Vault</div>
                        <div onclick="getBalance()" class="ui secondary green button">Get Balances</div>
                    </div>
                </div>
                <div class="emblems"> </div>
                
                <div class="ui icon attached loading message">
                    <i class="notched circle loading icon"></i>
                    <div class="content">
                        <div class="header">
                        Just one second
                        </div>
                        <p>We're fetching that content for you.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="ui login basic modal">
                <i class="close icon"></i>
                <div class="header">
                    Login to Emblem Vault
                </div>
                <div class=" content">
                    <div class="description">
                        <div class="unloq-login">
                            <script type="text/javascript" src="https://plugin.unloq.io/login.js"  data-unloq-key="53ffb528-eb38-40d3-a5e0-4f5bb90f1d32-iwC9XejJ" data-unloq-init="onUnloqInit"></script>
                        </div>
                    </div>
                </div>                
            </div>
            <div class="ui register basic modal">
                        <i class="close icon"></i>
                        <div class="header">
                            Register with Emblem Vault
                        </div>
                        <div class=" content">
                            <div class="description">
                                    <div class="unloq-register">
                                            <script src="https://plugin.unloq.io/register.js" data-unloq-key="41e83ef7-52d0-44f1-918f-b16028ce5a78-iaOs7g0l" data-unloq-init="onUnloqInit"></script>
                                        </div>
                            </div>
                        </div>
                    </div>
                    
            <div class="ui send modal">
                <i class="close icon"></i>
                <div class="header">
                    Send Emblem
                </div>
                <div class="image content">
                    <div class="ui medium image">
                    <img src="site-logo.svg">
                    <span>
                        <h1>Vault</h1>
                    </span>
                    </div>
                    <div class="description">
                    <div class="ui header">What you should know about sending an Emblem Vault</div>
                    <p>When you send this emblem to someone else you no longer are able to unlock the contents. </p>
                    <p>Are you sure you want to send this vault to another wallet?</p>
                    </div>
                </div>
                <div class="actions">
                    <div class="ui black deny button">
                    Nope
                    </div>
                    <div class="ui positive right labeled icon button">
                    Yep, I know what I'm doing
                    <i class="checkmark icon"></i>
                    </div>
                </div>
            </div>
            <div class="ui open basic modal">
                <div class="ui icon header">
                    <i class="archive icon"></i>
                    Open Vault
                </div>
                <div class="content">
                    <p>Opening this vault will remove the ability to send to other users and will grant you exclusive access to the contents. </p>
                </div>
                <div class="actions">
                    <div class="ui red basic cancel inverted button">
                    <i class="remove icon"></i>
                    No
                    </div>
                    <div class="ui green ok inverted button">
                    <i class="checkmark icon"></i>
                    Yes
                    </div>
                </div>
            </div>
            <!-- Trophy Case -->
            <div class="ui trophy modal">
                <i class="close icon"></i>
                <div class="header">
                    Emblem Trophy Case
                </div>
                <div class="content">
                    
                    <div class="description">
                    <div class="ui header">You are viewing the collectable trophy case for Emblem: <span class="name"></span></div>
                    <div class="ui three column doubling grid container cats"></div>
                    </div>
                </div>
                <div class="actions">
                    <!-- <div class="ui black deny button">
                    Nope
                    </div> -->
                    <div class="ui positive right labeled icon button">
                    Share
                    <i class="share icon"></i>
                    </div>
                </div>
            </div>
            <div class="confirm-content"></div>
            <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
            <script src="bower_components/jquery/dist/jquery.min.js" crossorigin="anonymous"></script>
            <script src="semantic/dist/semantic.min.js"></script>
            <script src="semantic/dist/components/accordion.min.js"></script>
            <script src="bower_components/handlebars/handlebars.js"></script>
            <script src="./bundle.js"></script>
        <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
        <link rel="stylesheet" type="text/css" href="semantic/dist/components/accordion.min.css">
        <script>
            var inElectron
                /* window.mobileAndTabletcheck = function () {
                    var check = false;
                    (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true })(navigator.userAgent || navigator.vendor || window.opera);
                    return check;
                } */
                try {
                    //$ = jQuery = module.exports;
                    window.$ = window.jQuery = require('bower_components/jquery/dist/jquery.min.js')
                } catch (e) { }
                /* Electron */
                /* try {
                    var remote = require('remote');
                    var Menu = remote.require('menu');
                    var MenuItem = remote.require('menu-item');
                    var menu = new Menu();
                    menu.append(new MenuItem({ label: 'Dev Tools', click: function () { remote.getCurrentWindow().toggleDevTools(); } }));
                    //menu.append(new MenuItem({ type: 'separator' }));
                    //menu.append(new MenuItem({ label: 'MenuItem2', type: 'checkbox', checked: true }));
                    window.addEventListener('contextmenu', function (e) {
                        e.preventDefault();
                        menu.popup(remote.getCurrentWindow());
                    }, false);
                    inElectron = true
                } catch (e) {
                    console.warn("Not loaded inside electron", e)
                    inElectron = false
                }*/
                /* PhoneGap */
                /* if (mobileAndTabletcheck()) {
                    var phonegap = require('phonegap')
                }  */
                
            var hdkey = new new Coval.Coval().Secure.HDKey()
            var keys = []
            var share, emblem
            function getWallet() {
                if (!localStorage.getItem('coval-testnet')) {
                    checkForAuth(getWallet)                  
                } else {
                    if (!JSON.parse(localStorage.getItem('coval-testnet'))[0].address) {
                        var token = JSON.parse(localStorage.getItem('coval-testnet'))[0].accessToken
                        checkForAuth(function(){
                            keys[0] = hdkey.StandardHDKey('0', function(address, key){
                                localStorage.setItem('coval-testnet', JSON.stringify([{address: address, key:key}]))
                                
                                return {address: address, key: key}
                            })
                            keys[0].accessToken = token
                            publishPubkey()
                            $(".my-address").text(keys[0].address)
                            getBalance()
                        })                        
                    } else {
                        checkForAuth(function(){
                            keys = JSON.parse(localStorage.getItem('coval-testnet'))
                            $(".my-address").text(keys[0].address)
                            getBalance()
                        })
                    }
                }                
            }
            function checkForAuth(callback){
                var storage = JSON.parse(localStorage.getItem('coval-testnet'))
                if (!storage || !storage[0].accessToken) {
                    if (window.location.hash.split('?')[0] === "#register") {
                        $('.ui.register.modal').modal('show')
                    } else if(window.location.hash.split('?')[0] === "#confirm") {
                        
                    } else {
                        $('.ui.login.modal').modal('show')
                    }
                } else {
                    return callback()
                }  
            }
            function reset() {
                localStorage.clear()
                window.location.reload()
            }
            function getShare() {
                $(".loading").show()
                var shares = shares
                var ifPrivate = ""
                if($('.ui.checkbox input').is(":checked")) {
                    ifPrivate = "&pvt=true"
                }
                var queryURL = "https://www.synrgtech.net/split?address=" + keys[0].address + "&name=" + $('.requested-name').val() + "&unloq_id="+keys[0].accessToken.unloq_id + ifPrivate
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    share = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    if (!keys[0].emblems) {keys[0].emblems = []}
                    keys[0].emblems[keys[0].emblems.length] = {name: val.payload.import_response.name, shares: val}
                    localStorage.setItem('coval-testnet', JSON.stringify(keys))
                    getBalance()
                })
            }
            function signAndSendTransaction(name, to) {
                getRawTx(name, to/* "1BnAHkLchRJwxaSqV7XoB2jAAwZUE4SoHb" */, function(template){ 
                    signTransaction(template, function(signed){
                        sendSignedTx(signed, name, function(txid){
                            getBalance()
                        })
                    })
                })
            }
            function publishPubkey() {
                var signer = getSigner()
                var bitcore = hdkey.GetBitcore()
                var pubkey = bitcore.PublicKey(signer.publicKey)
                //console.log({address: keys[0].address, pubkey: pubkey.toString("hex"), signerpub: signer.publicKey.toString('hex')})
                var queryURL = "https://www.synrgtech.net/keyring-publish?address=" + keys[0].address + "&pubkey=" + pubkey.toString("hex")
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(tx) {
                    console.log("published to keyring at tx", tx)
                    //return cb(tx)
                })
            }
            function getRawTx(name, to, cb) {
                var queryURL = "https://www.synrgtech.net/multichain-get-raw-tx?from=" + keys[0].address + "&name=" + name + "&to="+to
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(tx) {
                    return cb(tx)
                })
            }

            function sendSignedTx(signed, name, cb) {
                var signer = getSigner()
                var signed_hex = signer.toBuffer(signed).toString("hex")
                var my_share = getEmblemByName(emblem_name).shares.my_share
                var queryURL = "https://www.synrgtech.net/emblem-send?my_share="+my_share+"&signed_tx=" + signed_hex + "&unloq_id=" + keys[0].accessToken.unloq_id + "&address=" + keys[0].address
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(txid) {
                    return cb(txid)
                })
            }
            function signTransaction(raw, cb) {
                var signer = getSigner()
                var signed = signer.sign(raw.decoded, 0, raw.redeemScript, false)
                signed.then(function(s){
                    return cb(s)
                })                
            }
            function getSigner(){
                var pubKeyHashVersion = "00"
                var privateKeyVersion = "80"
                var checksumValue = "00000000"
                var bitcore = hdkey.GetBitcore()
                var bitcore_key = new bitcore.HDPrivateKey(keys[0].key)
                var k = bitcore_key.derive("m/0'/0/" + 0, false)
                var wif = k.privateKey.toWIF()
                var signer = MultiSign.fromWIF(wif, pubKeyHashVersion, privateKeyVersion, checksumValue)
                return signer
            }
            function claimEmblem(emblem_name) {
                $(".loading").show()
                $(".emblems").html("")
                //https://www.synrgtech.net/claim?name=EMB377379&address=12vJVPZdjfUwGzXs6BB5gFd5uxTtLx6iew&unloq_id=4135&my_share=
                var queryURL = "https://www.synrgtech.net/claim?name="+emblem_name+"&address=" + keys[0].address +  "&unloq_id=" + keys[0].accessToken.unloq_id + "&my_share=" + getEmblemByName(emblem_name).shares.my_share
                console.log(queryURL)
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    var seed = val                    
                    var emblem = getEmblemByName(emblem_name)
                    emblem.claimed = emblem.shares
                    emblem.shares = { emblem_seed: val.emblem_seed }  
                    emblem.shares.payload = emblem.claimed.payload
                    emblem.claimed.payload = {}                  
                    localStorage.setItem('coval-testnet', JSON.stringify(keys))
                    getBalance()
                })
            }

            function openClaimModal(emblem) {
                    var claim_modal = $('.ui.open.modal').modal('setting', {
                        closable: false,
                        onDeny: function () {
                            claim_modal.modal('hide')
                            return false;
                        }, onApprove: function(){
                            //alert("Opening " + emblem)
                            claimEmblem(emblem)
                        }
                    })
                    claim_modal.modal('show')
                }
            function getBalance() {
                $(".loading").show()
                $(".emblems").html("")
                var queryURL = "https://www.synrgtech.net/address-balances?address=" + keys[0].address
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    emblem = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    var emblemHtml = "<div class='emblem ui styled accordion'>"
                    val.forEach((element, index) => {
                        var validity = "(claimed)"
                        if (isClaimable(element.name)) {
                            validity = "(claimable)"
                        }
                        var visibility = '<i class="unlock icon"></i>'
                        if (isPrivate(element.name)) {
                            var _emblem = getEmblemByName(element.name)
                            var hidden_name = ""
                            if (_emblem.shares.payload.provided_name) {
                                hidden_name = 'data-content="Emblem Name: '+_emblem.shares.payload.provided_name+'"'
                            }
                            visibility = '<i '+hidden_name+' class="lock icon"></i>'
                        }
                        var buttons = "<p><div onclick=\"openTrophyCase('"+element.name+"')\" class=\"ui orange label submit button\">View Trophy Case</div><div onclick=\"openClaimModal('"+element.name+"')\" class=\"ui teal label submit button\">Open Vault</div> <div onclick=\"$('.ui.send.modal').modal('show')\" class=\"ui label green button\">Send</div></p>"
                        emblemHtml = emblemHtml + "<div class='title'><i class='dropdown icon'></i>"+visibility+" "+ getProvidedName(element.name) + " " + element.name+" "+validity+"</div><div class='content'><p class='transition hidden'>"
                        if (isClaimable(element.name)) {
                            emblemHtml = emblemHtml + buttons
                        } else {
                            if (!getEmblemByName(element.name).shares) {
                                emblemHtml = emblemHtml + "<p>Partially received....</p>"
                            } else {
                                emblemHtml = emblemHtml + "<p>Claimed Seed: " + getEmblemByName(element.name).shares.emblem_seed + "</p>"
                            }
                        }
                        var addresses = getEmblemInternalAddresses(element.name)
                        Object.keys(addresses).forEach((key, i) => {
                            var address = addresses[key].address
                            var address_visibility = ""
                            if (isPrivate(element.name)) {
                                address = "<i data-content=\" "+addresses[key].address+" \" class=\"user secret icon\"></i>"
                                address_visibility = visibility
                            }
                            var unit = addresses[key].unit
                            emblemHtml = emblemHtml + "<div><img width='16px' class=\"unit\" onerror=\"this.style.display='none'\" src='cryptocurrency-icons/32/color/"+unit.toLowerCase()+".png'/>" + address_visibility + key + " : " + address + "</div>"
                            if (i == Object.keys(addresses).length -1) {
                                emblemHtml = emblemHtml + "</p></div>"
                                
                            }
                        })
                        if (index == val.length -1) {
                            //emblemHtml = emblemHtml + "</div>"
                            $(".emblems").append(emblemHtml)
                        }
                    })
                    $('.ui.sticky').sticky({
                        context: '#context'
                    })
                    $(".loading").hide()
                    $('.emblem.ui.accordion').accordion()
                    $('.title .lock[data-content]').popup({ inline: true })
                    $('i.user').popup({ inline: true })
                })
            }
            function getEmblemByName(name){
                var records = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (records.length === 0) { 
                    return {}
                }
                return records[0]
            }
            function getProvidedName(name) {
                var emblem = getEmblemByName(name)
                var _name
                if (!emblem.shares) {
                    _name = "Partially Received Emblem"
                } else if (emblem.shares.payload.emblem_type === "private" && emblem.shares.payload.provided_name !== undefined) {
                    _name = "Name Hidden"
                }
                return _name || emblem.shares.payload.provided_name || ""
            }
            function isClaimable(name) {                
                var records = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (records.length === 0) {
                    return false
                } 
                return records[0].shares.my_share !== undefined
                
            }
            function isPrivate(name) {
                var records = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (records.length === 0) {
                    return false
                } 
                return (records[0]).shares.payload.emblem_type === "private"
            }

            function getEmblemInternalAddresses(name) {
                var filteredKeys = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (filteredKeys.length > 0) {
                    return filteredKeys[0].shares.payload.addresses
                } else {
                    return []
                }
                
            }
            function openTrophyCase(name){
                var kitties = ""
                $(".ui.trophy.modal .name").html(name)
                var emb = getEmblemByName(name)
                    /* var addy
                    if (name === "EMB619393") { 
                        addy = "0x5a63264914a1ecb626e32e8ad683704ba7b0621f"
                    } else {
                        addy = "0x09c3299528707f531d6ff16c362ca8ecbdc9a05a"
                    }
                    emb.shares.payload.addresses.ethereum = {address: addy, unit: "eth"} */
                    //console.log("address", emb.shares.payload.addresses.ethereum.address)
                    ck.getUserKitties(emb.shares.payload.addresses.ethereum.address).then((resp)=>{
                        resp.forEach((cat)=>{
                            console.log(cat)
                            var cat_name
                            if (cat.name) {
                                cat_name = cat.name
                            } else {
                                cat_name = cat.id
                            }
                            //console.log(cat_name)
                            kitties = kitties + "<div class=\"column\"><div class=\"ui segment\"><img style=\"display:block;margin:auto;\" width=\"50%\"src=\""+cat.image_url_cdn+"\"><span style=\"text-align:center;\"><h3>" + cat_name + "</h3></span></div></div>"
                            $(".ui.trophy.modal .cats").html(kitties)
                        })
                        
                        $('.ui.trophy.modal').modal('show')
                        
                    })
                    
            }
            /* UNLOQ LOGIN */
            function handleLoginSuccess(accessToken) {
                var storage
                if (!localStorage.getItem('coval-testnet')) {
                    storage = [{accessToken: null}]
                    
                } else {
                    storage = JSON.parse(localStorage.getItem('coval-testnet'))
                }
                storage[0].accessToken = accessToken
                localStorage.setItem('coval-testnet', JSON.stringify(storage))
                $('.ui.login.modal').modal('hide')
                getWallet()
            }

            $( document ).ready(function() {
                getWallet()
                $('.ui.checkbox').checkbox()
            })

            /* UNLOQ AUTOEXEC */
            var accessToken, coval
            (function () {
                function onTokenReceived(accessToken) {
                    // Call your API with the user's access token
                    console.log("UNLOQ access token", accessToken);
                    handleLoginSuccess(accessToken)
                    //postBackToCovalApiViaZap(accessToken)

                }
                UNLOQ.onLogin(handleLoginSuccess)
                window.onUnloqInit = function OnUNLOQInit() {
                    /* UNLOQ.onRegister(function(identity){
                        postBackToCovalApiViaZap(identity)
                    }) */
                    //$.QueryString["token"]
                    return {
                        callback: onTokenReceived, // Once a user logs in and an UNLOQ access token is generated,
                        // call this function in stead of performing the browser redirect.
                        public_key: "PEM-encoded public key" // Optionally, include a public key when requesting the
                        // user's personal encryption key.
                    }
                }
                window.onUnloqLogin = function(){
                    console.log("Logged in!!!")
                    return {
                        callback: onTokenReceived, // Once a user logs in and an UNLOQ access token is generated,
                        // call this function in stead of performing the browser redirect.
                        public_key: "PEM-encoded public key" // Optionally, include a public key when requesting the
                        // user's personal encryption key.
                    }
                }
            })()

        </script>
        <script>if (window.module) module = window.module;</script>
        </body>
</html>
