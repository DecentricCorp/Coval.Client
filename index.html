<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Semantic UI &amp; Webpack 2</title>
<script src="./bundle.js"></script>
        <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
        <link rel="stylesheet" type="text/css" href="semantic/dist/components/accordion.min.css">
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script src="semantic/dist/semantic.min.js"></script>
        <script src="semantic/dist/components/accordion.min.js"></script>
        <script>
            var hdkey = new new Coval.Coval().Secure.HDKey()
            var keys = []
            var share, emblem
            function getWallet() {
                if (!localStorage.getItem('coval-testnet')) {
                    keys[0] = hdkey.StandardHDKey('0', function(address, key){
                        localStorage.setItem('coval-testnet', JSON.stringify([{address: address, key: key }]))
                        return {address: address, key: key }
                    })
                } else {
                    keys = JSON.parse(localStorage.getItem('coval-testnet'))
                }
                $(".my-address").text(keys[0].address)
                getBalance()
            }
            function reset() {
                localStorage.clear()
                getWallet()
            }
            function getShare() {
                $(".loading").show()
                var queryURL = "https://www.synrgtech.net/split"
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    share = val
                    //var html = '<img src=""/>' + val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    getToken(val)
                })
            }
            function getToken(shares) {
                var shares = shares
                var queryURL = "https://www.synrgtech.net/address-import?address=" + keys[0].address + "&name=" + $('.requested-name').val()
                
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    emblem = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    if (!keys[0].emblems) {keys[0].emblems = []}
                    keys[0].emblems[keys[0].emblems.length] = {name: val.name, shares: shares}
                    localStorage.setItem('coval-testnet', JSON.stringify(keys))
                    getBalance()
                })
            }

            function getBalance() {
                $(".loading").show()
                $(".emblems").html("")
                var queryURL = "https://www.synrgtech.net/address-balances?address=" + keys[0].address
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    emblem = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    var emblemHtml = "<div class='emblem ui styled accordion'>"
                    val.forEach((element, index) => {
                        var validity = "(no shares stored)"
                        if (isClaimable(element.name)) {
                            validity = "(claimable)"
                        }
                        var buttons = "<p><div onclick=\"$('.ui.basic.modal').modal('show')\" class=\"ui teal label submit button\">Open Vault</div> <div onclick=\"$('.ui.send.modal').modal('show')\" class=\"ui label green button\">Send</div></p>"
                        emblemHtml = emblemHtml + "<div class='title'><i class='dropdown icon'></i>"+element.name+" "+validity+"</div><div class='content'><p class='transition hidden'>" + buttons//)//"<div class='ui header'>"+element.name+" "+validity+"</div>"
                        var addresses = getEmblemInternalAddresses(element.name)
                        Object.keys(addresses).forEach((key, i) => {
                            var address = addresses[key].address
                            var unit = addresses[key].unit
                            emblemHtml = emblemHtml + "<div><img width='16px' onerror=\"this.style.display='none'\" src='cryptocurrency-icons/32/color/"+unit+".png'/>" + key + " : " + address + "</div>"
                            if (i == Object.keys(addresses).length -1) {
                                emblemHtml = emblemHtml + "</p></div>"
                                
                            }
                        })
                        if (index == val.length -1) {
                            //emblemHtml = emblemHtml + "</div>"
                            $(".emblems").append(emblemHtml)
                        }
                    })
                    $('.ui.sticky').sticky({
                        context: '#context'
                    })
                    $(".loading").hide()
                    $('.emblem.ui.accordion').accordion()
                })
            }

            function isClaimable(name) {
                return keys[0].emblems.filter(function(emblem){return emblem.name == name}).length > 0
            }

            function getEmblemInternalAddresses(name) {
                return keys[0].emblems.filter(function(emblem){return emblem.name == name})[0].shares.payload.addresses
            }

            $( document ).ready(function() {
                getWallet()                
            });
        </script>
        <style>
            .raw-data {
                width: 100%;
                /* height: -webkit-fill-available; */
                visibility:collapse;
            }
            .loading {
                display: none;
            }
            .ui.rail {
                padding-left: 15px;
            }
            .send {
                padding: .38571429em 1em 1.4em !important
            }
            .reset {
                float: right;
            }
        </style>
</head>
<body>
    <div class="ui raised very padded text container segment">
        
        <h2 class="ui header">Emblem AlphaNet</h2>
        <div class="my-address"></div>
        <hr>
        <div class="reset"><div onclick="reset()" class="ui red label submit button transition visible">Reset Wallet!</div></div>
        <p>Welcome to the Emblem Vault - alpha client. </p> 
        <p><b>IMPORTANT! </b>This is not secure and may go away at any time. You should not send any value to your vaults that you don't want to lose! </p>
        <div class="ui segment">
            <div class="ui fluid form">
                <div class="two fields">
                    <div class="field">
                        <label>Emblem Name</label>
                        <input class="requested-name" placeholder="My secret vault" type="text">
                    </div>
                    <div class="field">
                            <label>Activity</label>
                        <div onclick="getShare()" class="ui secondary submit button">New Vault</div>
                        <div onclick="getBalance()" class="ui secondary green button">Get Balances</div>
                    </div>
                    <!-- <div class="field">
                        <label>Last Name</label>
                        <input placeholder="Last Name" type="text">
                    </div> -->
                </div>
                <div class="emblems"> </div>
                
                <div class="ui icon attached loading message">
                    <i class="notched circle loading icon"></i>
                    <div class="content">
                        <div class="header">
                        Just one second
                        </div>
                        <p>We're fetching that content for you.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ui send modal">
                <i class="close icon"></i>
                <div class="header">
                  Send Emblem
                </div>
                <div class="image content">
                  <div class="ui medium image">
                    <img src="site-logo.svg">
                    <span>
                        <h1>Vault</h1>
                    </span>
                  </div>
                  <div class="description">
                    <div class="ui header">What you should know about sending an Emblem Vault</div>
                    <p>When you send this emblem to someone else you no longer are able to unlock the contents. </p>
                    <p>Are you sure you want to send this vault to another wallet?</p>
                  </div>
                </div>
                <div class="actions">
                  <div class="ui black deny button">
                    Nope
                  </div>
                  <div class="ui positive right labeled icon button">
                    Yep, I know what I'm doing
                    <i class="checkmark icon"></i>
                  </div>
                </div>
              </div>

              <div class="ui basic modal">
                    <div class="ui icon header">
                      <i class="archive icon"></i>
                      Open Vault
                    </div>
                    <div class="content">
                      <p>Opening this vault will remove the ability to send to other users and will grant you exclusive access to the contents. </p>
                    </div>
                    <div class="actions">
                      <div class="ui red basic cancel inverted button">
                        <i class="remove icon"></i>
                        No
                      </div>
                      <div class="ui green ok inverted button">
                        <i class="checkmark icon"></i>
                        Yes
                      </div>
                    </div>
                  </div>
        </body>
</body>
</html>
