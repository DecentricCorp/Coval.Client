<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Emblem Alpha Client</title>

        
        <style>
            body {
                /* background: #25273e !important; */
                background-image: url('https://emblemvault.com/img/body-bg.jpg') !important;
                color: #cdae59 !important ;
            }
            .field label,
            .my-address {
                color: #cdae59 !important;
            }
            p,
            .emblem .title {
                color: rgb(255, 255, 255) !important;
            }
            .emblem .title:hover,
            .emblem .title.active,
            .text.menu .dropdown {
                color: white !important;
            }
            .requested-name {
                background-color: #5d5d5d !important;
            }
            .emblem.accordion,
            .loading.message {
                background-color: #7f86ad !important;
            }
            h2 {
                color: white !important;
            }
            .emblem-container {
                background: #25273e !important;
            }
            .emblem-group {
                background: #2e324e !important;
            }
            .raw-data {
                width: 100%;
                /* height: -webkit-fill-available; */
                visibility:collapse;
            }
            .loading {
                display: none;
            }
            .ui.rail {
                padding-left: 15px;
            }
            .send {
                padding: .38571429em 1em 1.4em !important;
            }
            .reset {
                float: right;
                padding-right: 5px;
            }
            .unit {
                margin-right: 5px;
                margin-bottom: -4px;
            }
        </style>
</head>
<body>
    <div></div>
    <input class="myFile" style="display:none" name="myFile" type="file">
    <div class="ui raised very padded text container segment emblem-container">
        
        <h2 class="ui header">Emblem Vault</h2>
        <hr>
        <div class="ui text menu">
            <div class="ui left item">
                <p class="my-address"></p>
            </div>
            <div class="ui right dropdown item">
                Wallet Actions
                <i class="dropdown icon"></i>
                <div class="menu">
                <div onclick="import_wallet()" class="item">Import Wallet</div>
                <div onclick="export_wallet()" class="item">Export Wallet</div>
                <div onclick="reset()" class="item">Reset Wallet</div>
                </div>
            </div>
        </div>
              
        <!-- <div class="reset"><div onclick="export_wallet()" class="ui green label submit button transition visible">Export Wallet!</div></div>
        <div class="reset"><div onclick="import_wallet()" class="ui orange label upload button transition visible">Import Wallet</div></div>
        <div class="reset"><div onclick="reset()" class="ui red label submit button transition visible">Reset Wallet!</div></div> -->
        
        <p>Welcome to the Emblem Vault - alpha client. </p> 
        <p><b>IMPORTANT! </b>This is not secure and may go away at any time. You should not send any value to your vaults that you don't want to lose! </p>
        <div class="ui segment emblem-group">
            <div class="ui fluid form">
                <div class="three fields">
                    <div class="field">
                        <label>Emblem Name</label>
                        <input class="requested-name" placeholder="My secret vault" type="text">
                    </div>
                    <div class="four wide field">
                        <label>Private</label>
                        <div class="ui toggle checkbox">                           
                            <input type="checkbox" name="private" tabindex="0" class="hidden">                          
                        </div>
                      </div>
                    <div class="eight wide field">
                            <label>Activity</label>
                        <div onclick="getShare()" class="ui secondary submit button">New Vault</div>
                        <div onclick="getBalance()" class="ui secondary green button">Get Balances</div>
                    </div>
                </div>
                <div class="emblems"> </div>
                
                <div class="ui icon attached loading message">
                    <i class="notched circle loading icon"></i>
                    <div class="content">
                        <div class="header">
                        Just one second
                        </div>
                        <p>We're fetching that content for you.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="ui wif modal">
            <i class="close icon"></i>
            <div class="header">
                Wallet Import Format
            </div>
            <div class="image content">
                <div class="ui medium image">
                <img src="site-logo.svg">
                <span>
                    <h1>Vault</h1>
                </span>
                </div>
                <div class="description">
                <div class="ui header">This is the key you can import into your coin client</div>
                <p style="color:black !important;">Info: A data interchange format designed to allow exporting and importing a single private key with a flag indicating whether or not it uses a compressed public key. </p>
                <a href="https://en.bitcoin.it/wiki/Wallet_import_format">More information about WIF format here</a>
                <div class="show_wif"></div>
                <i class="copy icon"></i>
                </div>
            </div>
            <div class="actions">
                <div class="ui black deny button">
                Done
                <i class="checkmark icon"></i>
                </div>
            </div>
        </div>        
            <div class="ui send modal">
                <i class="close icon"></i>
                <div class="header">
                    Send Emblem
                </div>
                <div class="image content">
                    <div class="ui medium image">
                    <img src="site-logo.svg">
                    <span>
                        <h1>Vault</h1>
                    </span>
                    </div>
                    <div class="description">
                    <div class="ui header">What you should know about sending an Emblem Vault</div>
                    <p style="color:black !important;">When you send this emblem to someone else you no longer are able to unlock the contents. </p>
                    <p>Are you sure you want to send this vault to another wallet?</p>
                    <div class="field">
                        <label>Destination Address</label><br>
                        <input class="destination-address" placeholder="Address goes here" type="text">
                    </div>
                    </div>
                </div>
                <div class="actions">
                    <div class="ui black deny button">
                    Nope
                    </div>
                    <div class="ui positive right labeled icon button">
                    Yep, I know what I'm doing
                    <i class="checkmark icon"></i>
                    </div>
                </div>
            </div>
            <div class="ui open basic modal">
                <div class="ui icon header">
                    <i class="archive icon"></i>
                    Open Vault
                </div>
                <div class="content">
                    <p>Opening this vault will remove the ability to send to other users and will grant you exclusive access to the contents. </p>
                </div>
                <div class="actions">
                    <div class="ui red basic cancel inverted button">
                    <i class="remove icon"></i>
                    No
                    </div>
                    <div class="ui green ok inverted button">
                    <i class="checkmark icon"></i>
                    Yes
                    </div>
                </div>
            </div>
            <!-- Trophy Case -->
            <div class="ui trophy modal">
                <i class="close icon"></i>
                <div class="header">
                    Emblem Trophy Case
                </div>
                <div class="content">
                    
                    <div class="description">
                    <div class="ui header">You are viewing the collectable trophy case for Emblem: <span class="name"></span></div>
                    <div class="ui three column doubling grid container cats link cards"></div>
                    </div>
                </div>
                <div class="actions">
                    <!-- <div class="ui black deny button">
                    Nope
                    </div> -->
                    <div class="ui positive right labeled icon button">
                    Share
                    <i class="share icon"></i>
                    </div>
                </div>
            </div>
            <div class="confirm-content"></div>
            <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
            <script src="bower_components/jquery/dist/jquery.min.js" crossorigin="anonymous"></script>
            <script src="semantic/dist/semantic.min.js"></script>
            <script src="semantic/dist/components/accordion.min.js"></script>
            <script src="bower_components/handlebars/handlebars.js"></script>
            <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.2.min.js"></script>
            <script src="./bundle.js"></script>
        <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
        <link rel="stylesheet" type="text/css" href="semantic/dist/components/accordion.min.css">
        
        <script>
            var inElectron
                /* window.mobileAndTabletcheck = function () {
                    var check = false;
                    (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true })(navigator.userAgent || navigator.vendor || window.opera);
                    return check;
                } */
                try {
                    //$ = jQuery = module.exports;
                    window.$ = window.jQuery = require('bower_components/jquery/dist/jquery.min.js')
                } catch (e) { }
                /* Electron */
                /* try {
                    var remote = require('remote');
                    var Menu = remote.require('menu');
                    var MenuItem = remote.require('menu-item');
                    var menu = new Menu();
                    menu.append(new MenuItem({ label: 'Dev Tools', click: function () { remote.getCurrentWindow().toggleDevTools(); } }));
                    //menu.append(new MenuItem({ type: 'separator' }));
                    //menu.append(new MenuItem({ label: 'MenuItem2', type: 'checkbox', checked: true }));
                    window.addEventListener('contextmenu', function (e) {
                        e.preventDefault();
                        menu.popup(remote.getCurrentWindow());
                    }, false);
                    inElectron = true
                } catch (e) {
                    console.warn("Not loaded inside electron", e)
                    inElectron = false
                }*/
                /* PhoneGap */
                /* if (mobileAndTabletcheck()) {
                    var phonegap = require('phonegap')
                }  */
                
            var hdkey = new new Coval.Coval().Secure.HDKey()
            var keys = []
            var share, emblem
            function getWallet() {
                if (!localStorage.getItem('coval-testnet')) {
                    checkForAuth(getWallet)                  
                } else {
                    if (!JSON.parse(localStorage.getItem('coval-testnet'))[0].address) {
                        var token = JSON.parse(localStorage.getItem('coval-testnet'))[0].accessToken
                        checkForAuth(function(){
                            hdkey.StandardHDKey('0', function(address, key){
                                localStorage.setItem('coval-testnet', JSON.stringify([{address: address, key:key, accessToken: token}]))
                                keys[0] = {address: address, key: key, accessToken: token}
                                publishPubkey()
                                $(".my-address").text(address)
                                getBalance()
                            })                            
                        })                        
                    } else {
                        checkForAuth(function(){
                            keys = JSON.parse(localStorage.getItem('coval-testnet'))
                            $(".my-address").text(keys[0].address)
                            getBalance()
                            publishPubkey()
                            pubnubInit()
                            
                        })
                    }
                }                
            }
            function checkForAuth(callback){
                var storage = JSON.parse(localStorage.getItem('coval-testnet'))
                if (!storage || !storage[0].accessToken) {
                    if (window.location.hash.split('?')[0] === "#register") {
                        $('.ui.register.modal').modal('show')
                    } else if(window.location.hash.split('?')[0] === "#confirm") {
                        
                    } else {
                        /* Disable UNLOQ */ //$('.ui.login.modal').modal('show')
                        generateEncryptionKey()
                    }
                } else {
                    return callback()
                }  
            }
            function generateEncryptionKey() {
                /* var bitcore = hdkey.GetBitcore()
                var id = Math.floor(Math.random() * (1000000 - 1) + 1)
                hdkey.StandardHDKey(id, function(address, key){
                    var keysha = bitcore.crypto.Hash.sha256(new Buffer(key.xprivkey)).toString('hex')
                    //console.log("keyz", address, key.xprivkey, unloq_key)
                    var accessToken = mockUnloq(id, keysha, key.xprivkey)
                    handleLoginSuccess(accessToken)
                }) */
                getNucypherPubkey(key=>{
                    var id = Math.floor(Math.random() * (1000000 - 1) + 1)
                    var accessToken = mockUnloq(id, key.key.privkey.hex, key)
                    handleLoginSuccess(accessToken)
                })

            }
            function mockUnloq(id, key, pk){
                var mock = { 
                    "method": "MOCK", 
                    "email": "", 
                    "unloq_id": id.toString(),
                    "unloq_key": key,
                    "token": "", 
                    "url": "",
                    "pk": pk
                }
                return mock
            }
            function reset() {
                localStorage.clear()
                window.location.reload()
            }
            function export_wallet() {
                var exp = localStorage.getItem('coval-testnet')
                saveTextAsFile(exp)
            }
            function import_wallet() {
                var files = $(".myFile")[0]
                $(files).one("change", function (ev) {
                    //if (files.files.length > 10) {
                        console.log("loaded")
                        loadFileAsText()
                        //return;
                    //}
                })
                $(".myFile")[0].click()
            }
            function saveTextAsFile(content) {
                var textToSave = content
                var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"})
                var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob)
                var fileNameToSaveAs = "Emblem-Backup.txt"
            
                var downloadLink = document.createElement("a")
                downloadLink.download = fileNameToSaveAs
                downloadLink.innerHTML = "Download File"
                downloadLink.href = textToSaveAsURL;
                downloadLink.onclick = destroyClickedElement
                downloadLink.style.display = "none"
                document.body.appendChild(downloadLink)
            
                downloadLink.click()
            }
            
            function destroyClickedElement(event) {
                document.body.removeChild(event.target);
            }
            
            function loadFileAsText() {
                var fileToLoad = $(".myFile")[0].files[0]
            
                var fileReader = new FileReader();
                fileReader.onload = function(fileLoadedEvent) 
                {
                    var textFromFileLoaded = JSON.parse(fileLoadedEvent.target.result);
                    localStorage.setItem('coval-testnet', JSON.stringify(textFromFileLoaded))
                    getWallet()
                };
                fileReader.readAsText(fileToLoad, "UTF-8");
            }
            function getShare() {
                $(".loading").show()
                var shares = shares
                var ifPrivate = ""
                if($('.ui.checkbox input').is(":checked")) {
                    ifPrivate = "&pvt=true"
                }
                var queryURL = "https://www.synrgtech.net/split?skip_unloq=true&unloq_key="+keys[0].accessToken.unloq_key+"&address=" + keys[0].address + "&name=" + $('.requested-name').val() + "&unloq_id="+keys[0].accessToken.unloq_id + ifPrivate
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    share = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    if (!keys[0].emblems) {keys[0].emblems = []}
                    keys[0].emblems[keys[0].emblems.length] = {name: val.payload.import_response.name, shares: val}
                    localStorage.setItem('coval-testnet', JSON.stringify(keys))
                    getBalance()
                })
            }
            function signAndSendTransaction(name, to) {
                $(".loading").show()
                getRawTx(name, to/* "1BnAHkLchRJwxaSqV7XoB2jAAwZUE4SoHb" */, function(template){ 
                    signTransaction(template, function(signed){
                        sendSignedTx(signed, name, to, keys[0].address, function(txid){
                            $(".loading").hide()
                            getBalance()
                        })
                    })
                })
            }
            function publishPubkey() {
                var signer = getSigner()
                var bitcore = hdkey.GetBitcore()
                var pubkey = bitcore.PublicKey(signer.publicKey)
                checkForPubkey(pubkeyLogged=>{
                    if (!pubkeyLogged) {
                        var pubkey = keys[0].accessToken.pk.key.pubkey.hex
                        var queryURL = "https://www.synrgtech.net/keyring-publish?address=" + keys[0].address + "&pubkey=" + pubkey.toString("hex")
                        $.ajax({
                            url: queryURL,
                            context: document.body
                        }).done(function(tx) {
                            console.log("published to keyring at tx", tx)
                            //return cb(tx)
                        })
                    }
                })
            }
            function getWIF(emblem_name, coin) {
                var emb = getEmblemByName(emblem_name)
                var seed = emb.shares.emblem_seed
                var _coval = new Coval.Coval()
                var _many = new _coval.Secure.ManyKeys(seed)
                var _keys = _many.GetAllKeys()
                var wif = _keys[coin].wif
                return wif

            }
            function getNucypherPubkey(cb) {
                var queryURL = "https://www.synrgtech.net/nucypher-key"
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(payload) {
                    console.log("made nucypher key", payload)
                    return cb(payload)
                })
                
            }
            function checkForPubkey(cb) {
                var queryURL = "https://www.synrgtech.net/keyring-stream-item?stream_key=" + keys[0].address
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(items) {
                    console.log("found items", items)
                    return cb(!items.error)
                }).fail(er=>{
                    console.log("grrr", er)
                    return cb(false)
                })
            }
            function getRawTx(name, to, cb) {
                var queryURL = "https://www.synrgtech.net/multichain-get-raw-tx?from=" + keys[0].address + "&name=" + name + "&to="+to
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(tx) {
                    return cb(tx)
                })
            }

            function sendSignedTx(signed, emblem_name, to, from, cb) {
                var signer = getSigner()
                var signed_hex = signer.toBuffer(signed).toString("hex")
                var my_share = getEmblemByName(emblem_name).shares.my_share
                var queryURL = "https://www.synrgtech.net/emblem-send?name="+emblem_name+"&signed_tx=" + signed_hex + "&address=" + to +"&key="+keys[0].accessToken.unloq_key + "&from=" + from
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(txid) {
                    return cb(txid)
                })
            }
        
            function signTransaction(raw, cb) {
                var signer = getSigner()
                var signed = signer.sign(raw.decoded, 0, raw.redeemScript, false)
                signed.then(function(s){
                    return cb(s)
                })                
            }
            function getSigner(){
                var pubKeyHashVersion = "00"
                var privateKeyVersion = "80"
                var checksumValue = "00000000"
                var bitcore = hdkey.GetBitcore()
                var bitcore_key = new bitcore.HDPrivateKey(keys[0].key)
                var k = bitcore_key.derive("m/0'/0/" + 0, false)
                var wif = k.privateKey.toWIF()
                var signer = MultiSign.fromWIF(wif, pubKeyHashVersion, privateKeyVersion, checksumValue)
                return signer
            }
            function claimEmblem(emblem_name) {
                $(".loading").show()
                $(".emblems").html("")
                var queryURL = "https://www.synrgtech.net/claim-nucypher?name="+emblem_name+"&address=" + keys[0].address
                if (keys[0].accessToken.unloq_key) {
                    queryURL = queryURL + "&key="+keys[0].accessToken.unloq_key
                }
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    var seed = val                    
                    var emblem = getEmblemByName(emblem_name)
                    emblem.claimed = emblem.shares
                    emblem.shares = { emblem_seed: val.emblem_seed }  
                    emblem.shares.payload = emblem.claimed.payload
                    emblem.claimed.payload = {}                  
                    localStorage.setItem('coval-testnet', JSON.stringify(keys))
                    getBalance()
                })
            }

            function openClaimModal(emblem) {
                    var claim_modal = $('.ui.open.modal').modal('setting', {
                        closable: false,
                        onDeny: function () {
                            claim_modal.modal('hide')
                            return false;
                        }, onApprove: function(){
                            //alert("Opening " + emblem)
                            claimEmblem(emblem)
                        }
                    })
                    claim_modal.modal('show')
            }
            function openSendModal(emblem){
                var send_modal = $('.ui.send.modal').modal('setting', {
                    onDeny: function () {
                        send_modal.modal('hide')
                            return false;
                        }, onApprove: function(){
                            var toAddress = $(".destination-address").val()
                            signAndSendTransaction(emblem, toAddress)
                            send_modal.modal('hide')
                            return false;
                        }
                })
                send_modal.modal('show')
            }
            function openWIFModal(emblem_name, coin){
                var wif = getWIF(emblem_name, coin)
                $(".show_wif").html(wif)
                var wif_modal = $('.ui.wif.modal').modal('setting', {
                    onDeny: function () {
                        wif_modal.modal('hide')
                            return false;
                        }
                })
                wif_modal.modal('show')
            }
            function getBitcoinBalance(emblem_name, address) {
                var queryURL = "https://blockchain.info/balance?active="+address+"&cors=true"
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    var balance_selector = "div:contains(bitcoin : "+address+")"
                    var container_selector = ".accordion:contains("+emblem_name+")"
                    $(container_selector).find(balance_selector).last().find(".balance").html(" <b>Balance: "+val[address].final_balance + "</b>")
                })
            }
            function getXcpBalance(emblem_name, address) {
                var queryURL = "https://xchain.io/api/balances/"+address+"&cors=true"
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    var balance_selector = "div:contains(coval : "+address+")"
                    var container_selector = ".accordion:contains("+emblem_name+")"
                    var coval_data = val.data.filter(coin=>{return coin.asset === "COVALC"})[0] || {quantity: 0}
                    $(container_selector).find(balance_selector).last().find(".balance").html(" <b>Balance: "+coval_data.quantity + "</b>")
                })
            }
            function getEthereumBalance(emblem_name, address) {
                var queryURL = "https://api.etherscan.io/api?module=account&action=balance&address="+address+"&tag=latest"
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    var balance_selector = "div:contains(ethereum : "+address+")"
                    var container_selector = ".accordion:contains("+emblem_name+")"
                    //var coval_data = val.data.filter(coin=>{return coin.asset === "COVAL"})[0] || {quantity: 0}
                    $(container_selector).find(balance_selector).last().find(".balance").html(" <b>Balance: "+val.result * .000000000000000001 + "</b>")
                })
            }
            function getEmblemType(emblem_name, cb){
                var queryURL = "https://www.synrgtech.net/stream-retrieve?stream_key="+emblem_name+":emblem_type"
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    return cb(val[0].decoded)
                })
            }
            function getEmblemName(emblem_name, cb){
                var queryURL = "https://www.synrgtech.net/stream-retrieve?stream_key="+emblem_name+":name"
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    if (val.length > 0){
                        return cb(val[0].decoded)
                    } else {
                        return cb()
                    }
                })
            }
            function getEmblemAddresses(emblem_name, cb){
                var queryURL = "https://www.synrgtech.net/stream-retrieve?stream_key="+emblem_name+":contents"
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    return cb(val[0].decoded)
                })
            }
            function getOpenSeaBalance(emblem_name) {
                var emb = getEmblemByName(emblem_name)
                $(".ui.trophy.modal .name").html(emblem_name)
                $(".ui.trophy.modal .cats").html("")
                //var address = "0x09c3299528707f531d6ff16c362ca8ecbdc9a05a"
                var address = emb.shares.payload.addresses.ethereum.address
                var queryURL = "https://1h6pof1izw-2.algolianet.com/1/indexes/*/queries?x-algolia-agent=Algolia%20for%20vanilla%20JavaScript%20(lite)%203.24.9%3Breact-instantsearch%205.0.0-beta.1%3BJS%20Helper%202.24.0&x-algolia-application-id=1H6POF1IZW&x-algolia-api-key=4df9c579a49b1ec507d7224052598f42"
                var data = {
                        "requests": [
                            {
                                "indexName": "assets_prod_main",
                                "params": "query=&maxValuesPerFacet=50&page=0&highlightPreTag=%3Cais-highlight-0000000000%3E&highlightPostTag=%3C%2Fais-highlight-0000000000%3E&facets=%5B%22_tags%22%2C%22owner.address%22%2C%22asset_contract.address%22%5D&tagFilters=&facetFilters=%5B%5B%22owner.address%3A"+address+"%22%5D%5D"
                            }
                        ]
                    }
                $.ajax({
                    type: "POST",
                    url: queryURL,
                    data: JSON.stringify(data)
                }).done(function(val){
                    var assets = ""
                    val.results[0].hits.forEach(asset=>{
                        console.log(asset.asset_contract.name, asset.name, asset.image_url)
                        assets = assets + "<div class=\"column\"><div class=\"ui segment card\"><img style=\"display:block;margin:auto;\" width=\"50%\"src=\""+asset.image_url+"\"><div class=\"content\"><div class=\"header\">" + asset.name + "<div class=\"meta\"><span class=\"date\">" + asset.asset_contract.name + "</span></div></div></div><div class=\"extra content\"><span><a target=\"_blank\" href=\"" + asset.external_link + "\">View on " + asset.asset_contract.name + " <i class=\"external alternate icon\"></i></a></span></div></div></div>"
                        $(".ui.trophy.modal .cats").html(assets)
                    })
                    $('.ui.trophy.modal').modal('show')
                })
            }
            function rnd(){
                return Math.floor(Math.random() * (1000000 - 1) + 1)
            }
            //var validity
            function getBalance() {
                $(".loading").show()
                $(".emblems").html("")
                var queryURL = "https://www.synrgtech.net/address-balances?address=" + keys[0].address + "&nocache=" + rnd()
                
                $.ajax({
                    url: queryURL,
                    context: document.body
                }).done(function(val) {
                    emblem = val
                    $('.raw-data').html($('.raw-data').html() + JSON.stringify(val, null, 4))
                    var emblemHtml = "<div class='emblem ui styled accordion'>"
                    val.forEach((element, index) => {
                        
                        if (!isStored(element.name)) {                            
                            storeEmblem(element.name, function(){
                                if (index == val.length -1) {
                                    getBalance()
                                }
                            })
                        } else {
                            doHtmlWork(element, function(){
                                if (index == val.length -1) {
                                    $(".emblems").append(emblemHtml)
                                }
                            })
                        }
                    })
                    function doHtmlWork(element, cb){
                        var validity = "(claimed)"
                        if (isClaimable(element.name)) {
                            validity = "(claimable)"
                        }
                        var visibility = '<i class="unlock icon"></i>'
                        if (isPrivate(element.name)) {
                            var _emblem = getEmblemByName(element.name)
                            var hidden_name = ""
                            if (_emblem.shares.payload.provided_name) {
                                hidden_name = 'data-content="Emblem Name: '+_emblem.shares.payload.provided_name+'"'
                            }
                            visibility = '<i '+hidden_name+' class="lock icon"></i>'
                        }
                        
                        emblemHtml = emblemHtml + "<div class='title'><i class='dropdown icon'></i>"+visibility+" "+ getProvidedName(element.name) + " " + element.name+" "+validity+"</div><div class='content'><p class='transition hidden'>"
                        if (isClaimable(element.name)) {
                            var buttons = "<p><div onclick=\"getOpenSeaBalance('"+element.name+"')\" class=\"ui orange label submit button\">View Trophy Case</div><div onclick=\"openClaimModal('"+element.name+"')\" class=\"ui teal label submit button\">Open Vault</div> <div onclick=\"openSendModal('"+element.name+"')\" class=\"ui label green button\">Send</div></p>"
                            emblemHtml = emblemHtml + buttons
                        } else {
                            if (!getEmblemByName(element.name).shares) {
                                emblemHtml = emblemHtml + "<p>Partially received....</p></div>"
                            } else {
                                emblemHtml = emblemHtml + "<p>Claimed Seed: " + getEmblemByName(element.name).shares.emblem_seed + "</p>"
                            }
                        }
                        var addresses = getEmblemInternalAddresses(element.name)
                        var generateHtml = function(index, addresses){
                            var keys = Object.keys(addresses)
                            var key = keys[index]
                            if (key === "bitcoin" || key === "coval" || key === "ethereum") {
                                if (key === "bitcoin") {
                                    getBitcoinBalance(element.name, addresses[key].address)
                                }
                                if (key === "coval") {
                                    getXcpBalance(element.name, addresses[key].address)
                                }
                                if (key === "ethereum") {
                                    getEthereumBalance(element.name, addresses[key].address)
                                }
                                var address = addresses[key].address
                                var address_visibility = ""
                                var display_address = ""
                                if (isPrivate(element.name)) {
                                    address = "<i style=\""+display_address+"\" data-content=\" "+addresses[key].address+" \" class=\"user secret icon\"></i>"
                                    address_visibility = visibility
                                }
                                var unit = addresses[key].unit
                                emblemHtml = emblemHtml + "<div style=\"line-height:28px;\"><img width='16px' class=\"unit\" onerror=\"this.style.display='none'\" src='cryptocurrency-icons/32/color/"+unit.toLowerCase()+".png'/>" + address_visibility + key + " : " + address + "<span class=\"balance\"></span></div>"
                                if (!isClaimable(element.name)) {
                                    var claim_buttons = "<p><div onclick=\"openWIFModal('"+element.name+"','"+key+"')\" class=\"ui green label submit button\">Get Wallet Import Format (WIF)</div></p>"
                                    emblemHtml = emblemHtml + claim_buttons
                                }
                            }
                            if (index === keys.length -1) {
                                emblemHtml = emblemHtml + "</p></div>"
                            } else {
                                generateHtml(index + 1, addresses)
                            }
                        }
                        generateHtml(0, addresses)
                        return cb()
                    }
                    $('.ui.sticky').sticky({
                        context: '#context'
                    })
                    $(".loading").hide()
                    $('.emblem.ui.accordion').accordion()
                    $('.title .lock[data-content]').popup({ inline: true })
                    $('i.user').popup({ inline: true })
                })
            }
            function getEmblemByName(name){
                var records = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (records.length === 0) { 
                    return {}
                }
                return records[0]
            }
            function getProvidedName(name) {
                var emblem = getEmblemByName(name)
                var _name
                if (!emblem.shares) {
                    _name = "Partially Received Emblem"
                } else if (emblem.shares.payload.emblem_type === "private" && emblem.shares.payload.provided_name !== undefined) {
                    _name = "Name Hidden"
                }
                return _name || emblem.shares.payload.provided_name || ""
            }
            function isClaimable(name) {                
                var records = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (records.length === 0) {
                    return false
                } 
                return records[0].claimed === undefined
                //return true
            }
            function isStored(name) {
                if (!keys[0].emblems) {
                    keys[0].emblems = []
                }
                var emblem = getEmblemByName(name)
                return !!emblem.name
            }
            function storeEmblem(name, cb) {
                getEmblemType(name, function(emblem_type){
                    getEmblemName(name, function(emblem_name){
                        getEmblemAddresses(name, function(addresses){
                            
                            keys[0].emblems[keys[0].emblems.length] = {
                                name: name,
                                shares:{
                                    payload: {
                                        emblem_type: emblem_type,
                                        addresses: JSON.parse(addresses),
                                        provided_name: emblem_name
                                    }
                                }
                            }
                            
                            localStorage.setItem('coval-testnet', JSON.stringify(keys))
                            return cb()
                        })
                    })
                })
            }
            function isPrivate(name) {
                var records = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (records.length === 0) {
                    return false
                } 
                return (records[0]).shares.payload.emblem_type === "private"
            }

            function getEmblemInternalAddresses(name) {
                var filteredKeys = keys[0].emblems.filter(function(emblem){return emblem.name == name})
                if (filteredKeys.length > 0) {
                    return filteredKeys[0].shares.payload.addresses
                } else {
                    return []
                }
                
            }
            function openTrophyCase(name){
                var kitties = ""
                $(".ui.trophy.modal .name").html(name)
                var emb = getEmblemByName(name)
                    /* var addy
                    if (name === "EMB619393") { 
                        addy = "0x5a63264914a1ecb626e32e8ad683704ba7b0621f"
                    } else {
                        addy = "0x09c3299528707f531d6ff16c362ca8ecbdc9a05a"
                    }
                    emb.shares.payload.addresses.ethereum = {address: addy, unit: "eth"} */
                    //console.log("address", emb.shares.payload.addresses.ethereum.address)
                    /*
                    *   Draw connections between parents and children
                    */
                    ck.getUserKitties(emb.shares.payload.addresses.ethereum.address).then((resp)=>{
                        resp.forEach((cat)=>{
                            console.log(cat)
                            var cat_name
                            if (cat.name) {
                                cat_name = cat.name
                            } else {
                                cat_name = cat.id
                            }
                            //console.log(cat_name)
                            kitties = kitties + "<div class=\"column\"><div class=\"ui segment card\"><img style=\"display:block;margin:auto;\" width=\"50%\"src=\""+cat.image_url_cdn+"\"><span style=\"text-align:center;\"><h3>" + cat_name + "</h3></span></div></div>"
                            $(".ui.trophy.modal .cats").html(kitties)
                        })
                        
                        $('.ui.trophy.modal').modal('show')
                        
                    })
                    
            }
            /* UNLOQ LOGIN */
            function handleLoginSuccess(accessToken) {
                var storage
                if (!localStorage.getItem('coval-testnet')) {
                    storage = [{accessToken: null}]
                } else {
                    storage = JSON.parse(localStorage.getItem('coval-testnet'))
                }
                storage[0].accessToken = accessToken
                localStorage.setItem('coval-testnet', JSON.stringify(storage))
                $('.ui.login.modal').modal('hide')
                getWallet()
            }

            $( document ).ready(function() {
                getWallet()
                $('.ui.checkbox').checkbox()
                $('.ui.dropdown').dropdown();
                
            })

            /* function write(){
                hdkey.StandardHDKey('0', function(address, key){
                    $($(".ui.header")[0]).html(address)
                })
                
            } */

            /* UNLOQ AUTOEXEC */
            var accessToken, coval
            (function () {
                /* function onTokenReceived(accessToken) {
                    // Call your API with the user's access token
                    console.log("UNLOQ access token", accessToken);
                    handleLoginSuccess(accessToken)
                    //postBackToCovalApiViaZap(accessToken)

                } */
                //UNLOQ.onLogin(handleLoginSuccess)
                //window.onUnloqInit = function OnUNLOQInit() {
                    /* UNLOQ.onRegister(function(identity){
                        postBackToCovalApiViaZap(identity)
                    }) */
                    //$.QueryString["token"]
                    //return {
                        //callback: onTokenReceived, // Once a user logs in and an UNLOQ access token is generated,
                        // call this function in stead of performing the browser redirect.
                        //public_key: "PEM-encoded public key" // Optionally, include a public key when requesting the
                        // user's personal encryption key.
                    //}
                //}
                /* window.onUnloqLogin = function(){
                    console.log("Logged in!!!")
                    return {
                        callback: onTokenReceived, // Once a user logs in and an UNLOQ access token is generated,
                        // call this function in stead of performing the browser redirect.
                        public_key: "PEM-encoded public key" // Optionally, include a public key when requesting the
                        // user's personal encryption key.
                    }
                } */
            })()

        </script>
        <script>if (window.module) module = window.module;</script>
        <script>
                var WalletChannel 
                var pubnub
                var getHistory
                
                function pubnubInit() {   
                    WalletChannel = "secrets."+keys[0].address
                    pubnub = new PubNub({
                        publishKey : 'pub-c-bdf47ac2-b687-4918-a720-bb2d3a1b204f',
                        subscribeKey : 'sub-c-360460ce-eca5-11e4-aafa-0619f8945a4f'
                    })
                        
                    function publishSampleMessage() {
                        console.log("Since we're publishing on subscribe connectEvent, we're sure we'll receive the following publish.");
                        var publishConfig = {
                            channel : WalletChannel,
                            message: { 
                                title: "greeting",
                                description: "hello world!"
                            }
                        }
                        pubnub.publish(publishConfig, function(status, response) {
                            console.log(status, response);
                        })
                    }
                        
                    pubnub.addListener({
                        status: function(statusEvent) {
                            if (statusEvent.category === "PNConnectedCategory") {
                                //publishSampleMessage();
                            }
                        },
                        message: function(msg) {
                            console.log(msg.message);
                        },
                        presence: function(presenceEvent) {
                            // handle presence
                        }
                    })
                    getHistory = function(){
                    pubnub.history(
                    {
                        channel: WalletChannel,
                        count: 100, // how many items to fetch
                        stringifiedTimeToken: true, // false is the default
                    },
                    function (status, response) {
                        console.log("history", response)
                    })
                }
                    console.log("Subscribing..");
                    pubnub.subscribe({
                        channels: [WalletChannel] 
                    });
                };
            </script>
        </body>
</html>
